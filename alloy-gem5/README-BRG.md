gem5 README BRG
===============

Last update : Jul 18, 2018
Author      : Tuan Ta

## BRG-related directory structure

- brg_exp/
  + Store all doit workflows used in BRG
  + Refer to brg_exp/README.md for more information about doit workflows

- run-app.py
  + Convenient python script to run an application. This script hides many
    unnecessary details of gem5 configuration, so it helps you run a quick
    app with gem5 with just a few important parameters.

- run-brg-tests.py
  + Testing script that works with brg-riscv-tests system. More details are
    included below.

- configs/brg-*
  + All BRG-specific configuration files will go here

## How to run BRG riscv tests on gem5

```
  cd $GEM5

  # clone brg-riscv-tests
  git clone git@github.com:cornell-brg/riscv-tests.git
  cd riscv-tests

  # build riscv assembly tests designed for gem5
  cd riscv-tests/isa
  make ps -j16

  # run riscv assembly tests
  cd $GEM5
  ./run-brg-tests.py --test-dir ./riscv-tests/isa/bin/

  # open test-summary file generated by the test script
  vim test-out/test-summary.out

  # build riscv pthread unit tests
  cd riscv-tests/pthread
  make -j8

  # run riscv pthread unit tests
  cd $GEM5
  ./run-brg-tests.py --test-dir ./riscv-tests/pthread/bin/

  # open test-summary file generated by the test script
  vim test-out/test-summary.out

```
- Current status of riscv tests and gem5
  + Some riscv asm tests for floating point instructions are failing because
    the current riscv implementation in gem5 is not fully and correctly
    supporting such instructions yet. Other than floating point instructions,
    a _fence-i_ instruction failed in O3 CPU model. Some word-sized shift
    instructions (e.g., srilw) fail with rv64.

  + Following is the list of known failed asm tests. _status_ numbers indicate
    what specific test cases in a test failed. _status = 255_ means that a
    simulation timed out.

```
    rv64ud-ps-fadd-AtomicSimpleCPU                     failed - status = 11
    rv64ud-ps-fadd-TimingSimpleCPU                     failed - status = 11
    rv64ud-ps-fadd-MinorCPU                            failed - status = 11
    rv64ud-ps-fadd-DerivO3CPU                          failed - status = 3
    rv64ud-ps-fclass-AtomicSimpleCPU                   failed - status = 10
    rv64ud-ps-fclass-TimingSimpleCPU                   failed - status = 10
    rv64ud-ps-fclass-MinorCPU                          failed - status = 10
    rv64ud-ps-fclass-DerivO3CPU                        failed - status = 10
    rv64ud-ps-fcmp-AtomicSimpleCPU                     failed - status = 8
    rv64ud-ps-fcmp-TimingSimpleCPU                     failed - status = 8
    rv64ud-ps-fcmp-MinorCPU                            failed - status = 8
    rv64ud-ps-fcmp-DerivO3CPU                          failed - status = 8
    rv64ud-ps-fcvt_w-AtomicSimpleCPU                   failed - status = 14
    rv64ud-ps-fcvt_w-TimingSimpleCPU                   failed - status = 14
    rv64ud-ps-fcvt_w-MinorCPU                          failed - status = 14
    rv64ud-ps-fcvt_w-DerivO3CPU                        failed - status = 14
    rv64ud-ps-fdiv-AtomicSimpleCPU                     failed - status = 16
    rv64ud-ps-fdiv-TimingSimpleCPU                     failed - status = 16
    rv64ud-ps-fdiv-MinorCPU                            failed - status = 16
    rv64ud-ps-fdiv-DerivO3CPU                          failed - status = 2
    rv64ud-ps-fmadd-DerivO3CPU                         failed - status = 3
    rv64ud-ps-fmin-AtomicSimpleCPU                     failed - status = 5
    rv64ud-ps-fmin-TimingSimpleCPU                     failed - status = 5
    rv64ud-ps-fmin-MinorCPU                            failed - status = 5
    rv64ud-ps-fmin-DerivO3CPU                          failed - status = 15
    rv64ud-ps-ldst-AtomicSimpleCPU                     failed - status = 6
    rv64ud-ps-ldst-TimingSimpleCPU                     failed - status = 6
    rv64ud-ps-ldst-MinorCPU                            failed - status = 6
    rv64ud-ps-ldst-DerivO3CPU                          failed - status = 6
    rv64ud-ps-move-AtomicSimpleCPU                     failed - status = 40
    rv64ud-ps-move-TimingSimpleCPU                     failed - status = 40
    rv64ud-ps-move-MinorCPU                            failed - status = 40
    rv64ud-ps-move-DerivO3CPU                          failed - status = 40
    rv64uf-ps-fadd-AtomicSimpleCPU                     failed - status = 11
    rv64uf-ps-fadd-TimingSimpleCPU                     failed - status = 11
    rv64uf-ps-fadd-MinorCPU                            failed - status = 11
    rv64uf-ps-fadd-DerivO3CPU                          failed - status = 3
    rv64uf-ps-fclass-AtomicSimpleCPU                   failed - status = 10
    rv64uf-ps-fclass-TimingSimpleCPU                   failed - status = 10
    rv64uf-ps-fclass-MinorCPU                          failed - status = 10
    rv64uf-ps-fclass-DerivO3CPU                        failed - status = 10
    rv64uf-ps-fcmp-AtomicSimpleCPU                     failed - status = 8
    rv64uf-ps-fcmp-TimingSimpleCPU                     failed - status = 8
    rv64uf-ps-fcmp-MinorCPU                            failed - status = 8
    rv64uf-ps-fcmp-DerivO3CPU                          failed - status = 8
    rv64uf-ps-fcvt_w-AtomicSimpleCPU                   failed - status = 14
    rv64uf-ps-fcvt_w-TimingSimpleCPU                   failed - status = 14
    rv64uf-ps-fcvt_w-MinorCPU                          failed - status = 14
    rv64uf-ps-fcvt_w-DerivO3CPU                        failed - status = 14
    rv64uf-ps-fdiv-AtomicSimpleCPU                     failed - status = 5
    rv64uf-ps-fdiv-TimingSimpleCPU                     failed - status = 5
    rv64uf-ps-fdiv-MinorCPU                            failed - status = 5
    rv64uf-ps-fdiv-DerivO3CPU                          failed - status = 2
    rv64uf-ps-fmadd-DerivO3CPU                         failed - status = 3
    rv64uf-ps-fmin-AtomicSimpleCPU                     failed - status = 5
    rv64uf-ps-fmin-TimingSimpleCPU                     failed - status = 5
    rv64uf-ps-fmin-MinorCPU                            failed - status = 5
    rv64uf-ps-fmin-DerivO3CPU                          failed - status = 15
    rv64uf-ps-move-AtomicSimpleCPU                     failed - status = 6
    rv64uf-ps-move-TimingSimpleCPU                     failed - status = 6
    rv64uf-ps-move-MinorCPU                            failed - status = 6
    rv64uf-ps-move-DerivO3CPU                          failed - status = 6
    rv64ui-ps-fence_i-DerivO3CPU                       failed - status = 2
    rv64ui-ps-srliw-AtomicSimpleCPU                    failed - status = 2
    rv64ui-ps-srliw-TimingSimpleCPU                    failed - status = 2
    rv64ui-ps-srliw-MinorCPU                           failed - status = 2
    rv64ui-ps-srliw-DerivO3CPU                         failed - status = 2
    rv64ui-ps-srlw-AtomicSimpleCPU                     failed - status = 2
    rv64ui-ps-srlw-TimingSimpleCPU                     failed - status = 2
    rv64ui-ps-srlw-MinorCPU                            failed - status = 2
    rv64ui-ps-srlw-DerivO3CPU                          failed - status = 2
```

- Current status of riscv pthread unit tests: Some std::thread tests timed out
  in TimingSimpleCPU model

```
    test_std_condition_variable-TimingSimpleCPU        failed - status = 255
    test_std_mutex-TimingSimpleCPU                     failed - status = 255
    test_std_thread-TimingSimpleCPU                    failed - status = 255
```

## How to implement custom CSR instructions in gem5

Custom CSRs can be used to direct gem5 to do some certain operations. In order
to define what operation(s) gem5 should execute when a custom CSR is set, go to
function `handleMiscRegOp` in `src/cpu/exec_context.hh` and simply add a new
case for your custom CSR. The naming list of custom CSRs for RISCV is in
`src/arch/riscv/registers.hh`. Please refer to an example of `MISCREG_CUSTOM0`
in function `handleMiscRegOp` to understand how to add a new custom CSR.
